[gd_scene load_steps=7 format=3 uid="uid://b85wfl7wt2xqw"]

[ext_resource type="Texture2D" uid="uid://dpd6sceqpsfv8" path="res://img — копия/Player.png" id="2_3oxyy"]

[sub_resource type="GDScript" id="GDScript_l35n4"]
script/source = "extends PathFollow2D

class_name Agent

var agent_resource : Resource

# stack of rooms left to visit in a trace
var path : Array = []
var current_room: int

var state : int = WANDER
var waypoint : Node2D
enum {
	WANDER,
	GOTO,
	STANDING
}

@export var agent_name : String = \"Brad\"
@export var speed : float = 0.1

func _ready() -> void:
	$Name.text = agent_name
	
	
func load_path(path_id:Array) -> void:
	path = path_id


func _on_travel():
	if path.is_empty(): 
		state = WANDER 
		return
		
	state = GOTO
	print(path)
	current_room = path.pop_front()
	
	if path.is_empty(): 
		state = WANDER 
		return
	
	waypoint = get_parent().get_parent().get_waypoint(path[0])
	

func _process(delta: float) -> void:
	match state:
		WANDER:
			progress_ratio += speed * delta
		GOTO:
			var raw_delta = waypoint.progress_ratio - progress_ratio
			
			var target = progress_ratio + raw_delta
			progress_ratio = move_toward(progress_ratio, target, speed * delta)
			
			progress_ratio = wrapf(progress_ratio, 0.0, 1.0)
				
			if abs(progress_ratio - waypoint.progress_ratio) < 0.001:
				var nextRoom = waypoint.leading_room
				progress_ratio = nextRoom.waypoints[current_room].progress_ratio
				
				self.visible = false
				self.global_position = nextRoom.global_position
				await get_tree().process_frame
				self.visible = true
				
				nextRoom.transfer(self)
				
"

[sub_resource type="AtlasTexture" id="AtlasTexture_oiqx7"]
atlas = ExtResource("2_3oxyy")
region = Rect2(0, 0, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_gs204"]
atlas = ExtResource("2_3oxyy")
region = Rect2(32, 0, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_odjie"]
atlas = ExtResource("2_3oxyy")
region = Rect2(64, 0, 32, 32)

[sub_resource type="SpriteFrames" id="SpriteFrames_g3b03"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_oiqx7")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_gs204")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_odjie")
}],
"loop": true,
"name": &"default",
"speed": 7.0
}]

[node name="Agent" type="PathFollow2D"]
rotates = false
script = SubResource("GDScript_l35n4")

[node name="Sprite2D" type="AnimatedSprite2D" parent="."]
sprite_frames = SubResource("SpriteFrames_g3b03")
autoplay = "default"
frame_progress = 0.965885

[node name="Name" type="Label" parent="."]
offset_left = -19.0
offset_top = -43.0
offset_right = 21.0
offset_bottom = -20.0
text = "Brad"
